x-app-urls: &test-app-defaults 
  CLIENT_URL: "${API_PROTOCOL}://app:${VITE_PORT}"
  VITE_API_URL: "${API_PROTOCOL}://app:${API_PORT}"
  NODE_ENV: test

services: 
  app:
    environment:
      <<: *test-app-defaults

  cypress: 
    build:
      context: .
      dockerfile: Dockerfile.cypress
      args: 
        COMPOSE_DOCKER_CLI_BUILD: 1
        DOCKER_BUILDKIT: 1
 
    depends_on:
      app:
        condition: service_healthy
      db:
        condition: service_healthy
    environment: 
      <<: *test-app-defaults
      # DB
      DB_USER: ${DB_USER}
      DB_HOST: db
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 5432
      TEST_DB_NAME: ${TEST_DB_NAME}
      # OUTPUT
      CYPRESS_QUIET: 1
      FORCE_COLOR: 1
      DEBUG: cypress:user:log
      NODE_DEBUG: console
    volumes: 
      - .:/e2e:ro
      - ./cypress:/e2e/cypress
      - ./cypress.config.cjs:/e2e/cypress.config.cjs
      - ./cypress/videos:/e2e/cypress/videos

    # TODO: CAN'T WRITE TO THIS FOLDER? 
    working_dir: /e2e
    
    # TOOD: move to package.json?
    command: npx cypress run --config-file cypress.config.cjs --browser chrome --headless

volumes: 
  postgres_data: 
